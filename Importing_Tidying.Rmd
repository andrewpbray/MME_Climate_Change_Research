---
title: "Research_Paper_Code"
author: "aaron till"
date: "5/24/2018"
output: github_document
--- 

## Data import

```{r installing packages}
library(rgdal)
library(stringr)
library(lubridate)
library(raster)
library(tidyverse)
```

```{r load data}
setwd('../data/')
MME <-read_csv("Fish Kill Data Updated 10_24_2018.csv")
thermal <-read_csv("thermal_metrics.csv")
NHD_WBIC <-read_csv("NHD_WBIC.csv")
thermal <- left_join(thermal, NHD_WBIC, by = "site_id")
```


## Prelimary cleaning

First we strip out unneeded columns and tidy. There are a few instances of multiple
MMEs being recorded in the same lake in the same month, we treat as just a single 
MME event.

```{r}
MME <- MME %>%
  filter(Min.Kill.Size!="Excludable") %>%
  dplyr::select(WBIC,
                Year,
                Cause.Category, Cause.Type,
                Investigation.Start.Month,
                Fishkill.Inv.Seq.No,
                Cause.Category.4) %>%
  rename(month = Investigation.Start.Month) %>%
  mutate(month = as.character(fct_recode(as.factor(month),
                                         "jan" = "Jan",
                                         "feb" = "Feb",
                                         "mar" = "Mar",
                                         "apr" = "Apr",
                                         "may" = "May",
                                         "jun" = "Jun",
                                         "jul" = "Jul",
                                         "aug" = "Aug",
                                         "sep" = "Sep",
                                         "oct" = "Oct",
                                         "nov" = "Nov",
                                         "dec" = "Dec")),
         WBIC = as.character(WBIC)) %>%
  distinct(WBIC, Year, month, .keep_all = TRUE)

names(MME) <- str_to_lower(names(MME))
```

For the thermal data, we first only retain distinct `Year` X `WBIC` combinations.
In general, these were distinct, but there were a few anomolous `WBIC` that
had multiple records for each year.

```{r}
thermal <- thermal  %>%
  filter(!is.na(WBIC)) %>%
  mutate(WBIC = as.character(WBIC)) %>%
  distinct(Year, WBIC, .keep_all = TRUE)

names(thermal) <- str_to_lower(names(thermal))
```

For now, we process the annual and monthly thermal data separately. This is for
the sake of computational efficiency; they are merged later.

```{r}
thermal_annual <- thermal %>%
  dplyr::select(-contains('jas'),
                -starts_with('mean_surf_'),
                -starts_with('mean_bot_'), 
                -starts_with('max_surf_'), 
                -starts_with('max_bot_'),
                -site_id)
 
thermal_monthly <- thermal %>%
  dplyr::select(starts_with('mean_surf_'),
                starts_with('mean_bot_'), 
                starts_with('max_surf_'), 
                starts_with('max_bot_'),
                -contains('jas'),
                year, wbic) %>%
  gather(key="type", value="temperature", 
         starts_with('mean_surf_'),
         starts_with('mean_bot_'), 
         starts_with('max_surf_'), 
         starts_with('max_bot_')) %>%
  separate(type, into=c('metric', 'depth', 'month'), sep='_')  %>%
  unite(metric, metric, depth) %>%
  spread(metric, temperature) %>%
  arrange(wbic, year, month)

rm(thermal)
```


## Merging MME with thermal and diagnostics

```{r}
tf <- thermal_monthly %>%
  left_join(thermal_annual)
```

We want to ensure that all of the MMEs find their way onto a row of `tf`, so
first some checks.

```{r eval = FALSE}
nrow(MME)
length(unique(MME$fishkill.inv.seq.no))
length(table(MME$wbic))
sum(table(MME$wbic))
```

So we learn that each of the `r nrow(MME)` rows in `MME` is a unique fishkill, there
are fewer unique lake `wbic`s because some lakes have had multiple MMEs, therefore
are found in multiple rows.

```{r}
df <- tf %>%
  left_join(MME)
```

Most of the new columns should be NAs because most year x month x wbic combos don't have
MME data. Hopefully the number of non-NAs is the same as the number of MMEs.

```{r eval = FALSE}
df %>%
  map(~sum(!is.na(.)))
```

That's an unexpected number. It's neither the total number of MMEs nor the total
number of unique `wbic`s. We can check to see how many of the MMEs correponded
to year x month x wbic combos that weren't unique, i.e. there were multiple MMEs
in the same lake in the same month.

```{r eval = FALSE}
MME %>%
  select(wbic, year, month) %>%
  duplicated() %>%
  sum()
```

So twelve of those MMEs were stacked up on top of others. They will be tacked on
to the bottom of the merged df with the thermal data copied over. That's fine, but
it still doesn't solve the problem.

We can also check to see if the wbic set in `MME` is a subset of those in `tf`.

```{r eval = FALSE}
length(intersect(MME$wbic, tf$wbic))
length(unique(MME$wbic))
```

Ah, so here is where we lose some MMEs: not all of the MMEs find matching `wbic` in the
thermals data set. That's a bummer. We can check to see if this explains all of the
discrepancy found in the join by doing this subsetting of MME before the join and check
if it looks the same as if we hadn't subsetted.

```{r eval = FALSE}
match_set <- intersect(MME$wbic, tf$wbic)
MME_shrunk <- MME %>%
  filter(wbic %in% match_set)

df2 <- tf %>%
  left_join(MME_shrunk)
```

Yep, they're the same, so that's the explanation.

## Cleaning and creating covariates for modeling

```{r}
df <- df %>%
  mutate(date = ymd(paste(year, month, "15"))) %>%
  filter(date > "2003-01-01", date < "2014-05-01") %>%
  mutate(mme  = ifelse(!is.na(fishkill.inv.seq.no), 1, 0),
         summerkill    = ifelse(cause.category.4 == "SUMMERKILL", 1, 0),
         winterkill    = ifelse(cause.category.4 == "WINTERKILL", 1, 0),
         infection     = ifelse(cause.category.4 == "INFECTIOUS AGENT", 1, 0),
         anthropogenic = ifelse(cause.category.4 == "ANTHROPOGENIC CONDITION", 1, 0))
```

**Question**: What is the difference between `Cause.Type` and `Cause.Category.4`?

Turn each of the temperature readings into z-scores based on their deviation from 
that lake's monthly data. Also add additional useful covariates and do some renaming.

```{r}
df <- df %>%
  group_by(wbic, month) %>%
  mutate(max_bot_z = scale(max_bot),
         max_surf_z = scale(max_surf),
         mean_bot_z = scale(mean_bot),
         mean_surf_z = scale(mean_surf)) %>%
  ungroup() %>%
  mutate(layer_diff = mean_surf - mean_bot,
         quadratic_temp = mean_surf^2,
         season = fct_collapse(month,
                               "winter" = "dec",
                               "winter" = "jan",
                               "winter" = "feb",
                               "spring" = "mar",
                               "spring" = "apr",
                               "spring" = "may",
                               "summer" = "jun",
                               "summer" = "jul",
                               "summer" = "aug",
                               "fall"   = "sep",
                               "fall"   = "oct",
                               "fall"   = "nov")) %>%
  rename(ice_duration = ice_duration_days,
         schmidt = schmidt_daily_annual_sum,
         variance_after_ice_30 = coef_var_0.30, 
         variance_after_ice_60 = coef_var_30.60, 
         cumulative_above_0 = gdd_wtr_0c,
         cumulative_above_5 = gdd_wtr_5c,
         cumulative_above_10 = gdd_wtr_10c)
```


# Add spatial data

First the spatial covariates of the lakes.

```{r}
spatial <- readOGR("lake_shapes", layer = 'model_lakes')
spatial_df <- as_tibble(spatial) %>%
  bind_cols(as.tibble(coordinates(spatial))) %>%
  mutate(site_id = as.character(site_id)) %>%
  left_join(NHD_WBIC, by = "site_id") %>%
  filter(!is.na(WBIC)) %>%
  rename(lat = V2,
         lon = V1)

names(spatial_df) <- str_to_lower(names(spatial_df))
rm(spatial)
```

Merge into existing data.

```{r}
df <- df %>%
  left_join(spatial_df, by = "wbic")
```

Next, the 2010 census block covariates from https://www.census.gov/geo/maps-data/data/tiger-data.html

```{r}
census <- readOGR("census_data", layer = 'tabblock2010_55_pophu')
census_df <- as_tibble(census) %>%
  select("POP10") %>%
  bind_cols(as_tibble(coordinates(census))) %>%
  rename(lat = V2,
         lon = V1)
  
names(census_df) <- str_to_lower(names(census_df))
rm(census)
```

```{r}
df <- df %>%
  left_join(census_df, by = c("lon", "lat")) %>%
  mutate(lon_round = round(lon, 1),
         lat_round = round(lat, 1)) %>%
  group_by(lon_round, lat_round) %>%
  summarize(population = sum(pop10))
```

# above not quite working
# DONE UP TILL HERE



```{r limiting size of coordinates}

main_data$long_round <- round(main_data$V1, 1)
main_data$lat_round <- round(main_data$V2, 1)
census_w_frame$long_round <- round(census_w_frame$V1, 1)
census_w_frame$lat_round <- round(census_w_frame$V2, 1)


```

```{r aggregate population by coordinates}

census_w_frame_summary <- census_w_frame %>%
  group_by(long_round, lat_round) %>%
  summarise(population = sum(POP10))

```

```{r}

main_data_census <- merge(main_data, census_w_frame_summary, full = TRUE) 
```


# Outline of wisconsin shapefile data



```{r importing spatial data}

setwd(input_path)


dsn2 <- "wisconsin_outline"
ogrListLayers(dsn2)
spatial_w <- readOGR(dsn2, layer = 'wisco_only')

```




# Future Data


```{r}

setwd(input_path)


raw_future_CSIRO <- read_tsv('ACCESS_thermal_metrics.tsv')

```

```{r tidying and converting for predictive data}
raw_future_CSIRO <- merge(raw_future_CSIRO, NHD_WBIC)

future_untidied <- raw_future_CSIRO%>%
  dplyr::select(-contains('jas')) %>%
  gather(key="type", value="temperature", starts_with('mean_surf_'),starts_with('mean_bot_'), starts_with('max_surf_'), starts_with('max_bot_')) %>%
  separate(type, into=c('metric', 'depth', 'Month'), sep='_')
  
  
future_untidied$Month <- str_to_title((future_untidied$Month)) 


```

```{r tidy 1}

future_gathered <- future_untidied %>%
  group_by(metric, depth, Month) %>%
  mutate(zscore_temp = (temperature - ave(temperature, site_id))/ sd(temperature)) %>%
  ungroup(metric, depth, Month)

#future_gathered <- future_gathered %>% #Remove this line to compare concurrent forecasting with reality
 # filter(year >= 2041)

```

```{r tidy 2}
future_spread <- future_gathered %>%
  mutate(type = paste(future_gathered$metric,'_', future_gathered$depth, sep = '')) %>% 
  mutate(typeZ = paste(type, 'Z', sep = '')) %>%
  dplyr::select(-metric, -depth) %>%
  distinct() %>%
  spread(key = type, value = temperature) %>%
  spread(key = typeZ, value = zscore_temp)


```


```{r tidying 3}

future_data <- future_spread %>%
  group_by(WBIC, site_id, Month, year, peak_temp) %>% 
  summarise(Ice_Duration = mean(ice_duration_days, na.rm = TRUE), Schmidt = mean(schmidt_daily_annual_sum, na.rm = TRUE), Variance_After_Ice_30 = mean(coef_var_0.30, na.rm = TRUE), Variance_After_Ice_60 = mean(coef_var_30.60, na.rm = TRUE), Cumulative_Above_0 = mean(gdd_wtr_0c, na.rm = TRUE), Cumulative_Above_5 = mean(gdd_wtr_5c, na.rm = TRUE), Cumulative_Above_10 = mean(gdd_wtr_10c, na.rm = TRUE), Mean_Surf_Temp = max(mean_surf, na.rm = TRUE), Max_Surf_Temp = max(max_surf, na.rm = TRUE), Mean_Bot_Temp = max(mean_bot, na.rm = TRUE), Max_Bot_Temp = max(max_bot, na.rm = TRUE), Mean_Surf_Zscore = max(mean_surfZ, na.rm = TRUE), Max_Surf_Zscore = max(max_surfZ, na.rm = TRUE), Mean_Bot_Zscore = max(mean_botZ, na.rm = TRUE), Max_Bot_Zscore = max(max_botZ, na.rm = TRUE)) %>%
  ungroup() 
```

```{r main data additional variables}

future_data$Year <- future_data$year
future_data$layer_dif <- future_data$Mean_Surf_Temp - future_data$Mean_Bot_Temp
future_data$quadratic_temp <- future_data$Mean_Surf_Temp^2 
future_data$Spring <- ifelse(future_data$Month == 'Mar' | future_data$Month == 'Apr' | future_data$Month == 'May', 1, 0)
```



```{r Creating Seasons}

future_data$Season <- future_data$Month

future_data$Season <- ifelse(future_data$Month =='Apr'| future_data$Month =='May', 'Spring', future_data$Season)



future_data$Season <- ifelse(future_data$Month =='Mar'| future_data$Month =='Dec'| future_data$Month =='Jan'| future_data$Month =='Feb', 'Winter', future_data$Season)


future_data$Season <- ifelse(future_data$Month =='Sep'|future_data$Month =='Jun'| future_data$Month =='Jul'| future_data$Month =='Aug', 'Summer', future_data$Season)


future_data$Season <- ifelse(future_data$Month =='Oct'| future_data$Month =='Nov', 'Fall', future_data$Season)


future_data$Season <-factor(future_data$Season, levels=c('Summer', 'Spring', 'Winter', 'Fall'))

```

```{r spatial future}
future_data <- merge(spatial_frame, future_data, all = FALSE)


```


```{r future coordinate rounding and merging with census data}

future_data$long_round <- round(future_data$V1, 1)
future_data$lat_round <- round(future_data$V2, 1)

future_data_census <- merge(future_data, census_w_frame_summary, full = TRUE) 
```


# Snowfall Data



```{r}


  
tidy_snow <- function(data_input, year, month) {
  
  e <-extent(-92.9, -87, 42.4 , 46.9)
  a <- crop(raster(data_input),e)
  
  a1 <- as.data.frame(coordinates(a))
  a2<- as.data.frame(a)
  
  data <- na.omit(cbind(a1, a2)) 
   
  names(data) <- c('x', 'y', 'snow')

  data$long_round <- round(data$x, 1)
  data$lat_round <- round(data$y, 1)  

  data_output <- data %>%
  group_by(long_round, lat_round) %>%
  summarise(Snow = mean(snow))
    
  
  data_output$Year <- year
  data_output$Month <- month
  return(data_output)

}


```


```{r}

setwd('/home/aatill/Till_Thesis/Summer_Research_Work/MME_Climate_Change_Research/Input_Data/Prism Data/PRISM_Precip/')

snow_data <- rbind(tidy_snow('2004/PRISM_ppt_stable_4kmM3_200401_asc.asc',2004, 'Jan'),
                        tidy_snow('2004/PRISM_ppt_stable_4kmM3_200402_asc.asc', 2004, 'Feb'),
                        tidy_snow('2004/PRISM_ppt_stable_4kmM3_200412_asc.asc', 2004, 'Dec'),
                        tidy_snow('2005/PRISM_ppt_stable_4kmM3_200501_asc.asc', 2005, 'Jan'),
                        tidy_snow('2005/PRISM_ppt_stable_4kmM3_200502_asc.asc', 2005, 'Feb'),
                        tidy_snow('2005/PRISM_ppt_stable_4kmM3_200512_asc.asc', 2005, 'Dec'),
                        tidy_snow('2006/PRISM_ppt_stable_4kmM3_200601_asc.asc', 2006, 'Jan'),
                        tidy_snow('2006/PRISM_ppt_stable_4kmM3_200602_asc.asc', 2006, 'Feb'),
                        tidy_snow('2006/PRISM_ppt_stable_4kmM3_200612_asc.asc', 2006, 'Dec'),
                        tidy_snow('2007/PRISM_ppt_stable_4kmM3_200701_asc.asc', 2007, 'Jan'),
                        tidy_snow('2007/PRISM_ppt_stable_4kmM3_200702_asc.asc', 2007, 'Feb'),
                        tidy_snow('2007/PRISM_ppt_stable_4kmM3_200712_asc.asc', 2007, 'Dec'),
                        tidy_snow('2008/PRISM_ppt_stable_4kmM3_200801_asc.asc', 2008, 'Jan'),
                        tidy_snow('2008/PRISM_ppt_stable_4kmM3_200802_asc.asc', 2008, 'Feb'),
                        tidy_snow('2008/PRISM_ppt_stable_4kmM3_200812_asc.asc', 2008, 'Dec'),
                        tidy_snow('2009/PRISM_ppt_stable_4kmM3_200901_asc.asc', 2009, 'Jan'),
                        tidy_snow('2009/PRISM_ppt_stable_4kmM3_200902_asc.asc', 2009, 'Feb'),
                        tidy_snow('2009/PRISM_ppt_stable_4kmM3_200912_asc.asc', 2009, 'Dec'),
                        tidy_snow('2010/PRISM_ppt_stable_4kmM3_201001_asc.asc', 2010, 'Jan'),
                        tidy_snow('2010/PRISM_ppt_stable_4kmM3_201002_asc.asc', 2010, 'Feb'),
                        tidy_snow('2010/PRISM_ppt_stable_4kmM3_201012_asc.asc', 2010, 'Dec'),
                        tidy_snow('2011/PRISM_ppt_stable_4kmM3_201101_asc.asc', 2011, 'Jan'),
                        tidy_snow('2011/PRISM_ppt_stable_4kmM3_201102_asc.asc', 2011, 'Feb'),
                        tidy_snow('2011/PRISM_ppt_stable_4kmM3_201112_asc.asc', 2011, 'Dec'),
                        tidy_snow('2012/PRISM_ppt_stable_4kmM3_201201_asc.asc', 2012, 'Jan'),
                        tidy_snow('2012/PRISM_ppt_stable_4kmM3_201202_asc.asc', 2012, 'Feb'), 
                        tidy_snow('2012/PRISM_ppt_stable_4kmM3_201212_asc.asc', 2012, 'Dec'),
                        tidy_snow('2013/PRISM_ppt_stable_4kmM3_201301_asc.asc', 2013, 'Jan'),
                        tidy_snow('2013/PRISM_ppt_stable_4kmM3_201302_asc.asc', 2013, 'Feb'), 
                        tidy_snow('2013/PRISM_ppt_stable_4kmM3_201312_asc.asc', 2013, 'Dec'))


```





